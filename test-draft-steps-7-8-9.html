<!DOCTYPE html>
<html>
<head>
    <title>Test Draft System - Steps 7, 8, 9</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .pass { color: green; }
        .fail { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Draft System Test - Steps 7, 8, 9</h1>
    
    <div class="test-section">
        <h2>Test 1: Check Field Names</h2>
        <button onclick="checkFieldNames()">Check for Duplicate Field Names</button>
        <div id="fieldNamesResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Load Current Draft</h2>
        <input type="text" id="draftIdInput" placeholder="Enter draft ID" value="draft_69316ce1746024.49125092">
        <button onclick="loadDraft()">Load Draft</button>
        <div id="draftResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Check Form Fields in DOM</h2>
        <button onclick="checkFormFields()">Check Form Fields</button>
        <div id="formFieldsResult"></div>
    </div>
    
    <script>
        function checkFieldNames() {
            const result = document.getElementById('fieldNamesResult');
            result.innerHTML = '<p class="info">Checking for duplicate field names...</p>';
            
            fetch('index.php')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Get all input fields
                    const inputs = doc.querySelectorAll('input[name], select[name], textarea[name]');
                    const fieldCounts = {};
                    const step7Fields = [];
                    const step8Fields = [];
                    const step9Fields = [];
                    
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name) {
                            fieldCounts[name] = (fieldCounts[name] || 0) + 1;
                            
                            // Check which step the field belongs to
                            let step = input.closest('[data-step]');
                            if (step) {
                                const stepNum = step.getAttribute('data-step');
                                if (stepNum === '7') step7Fields.push(name);
                                if (stepNum === '8') step8Fields.push(name);
                                if (stepNum === '9') step9Fields.push(name);
                            }
                        }
                    });
                    
                    // Find duplicates
                    const duplicates = Object.entries(fieldCounts).filter(([name, count]) => count > 2); // >2 because radio buttons have 2+ inputs
                    
                    let output = '<h3>Results:</h3>';
                    output += `<p>Total unique field names: ${Object.keys(fieldCounts).length}</p>`;
                    output += `<p>Step 7 fields: ${new Set(step7Fields).size}</p>`;
                    output += `<p>Step 8 fields: ${new Set(step8Fields).size}</p>`;
                    output += `<p>Step 9 fields: ${new Set(step9Fields).size}</p>`;
                    
                    if (duplicates.length > 0) {
                        output += '<p class="fail">⚠️ Duplicate field names found:</p><ul>';
                        duplicates.forEach(([name, count]) => {
                            output += `<li>${name}: ${count} instances</li>`;
                        });
                        output += '</ul>';
                    } else {
                        output += '<p class="pass">✓ No problematic duplicates found</p>';
                    }
                    
                    // List Step 7, 8, 9 fields
                    output += '<h4>Step 7 Fields:</h4><pre>' + JSON.stringify([...new Set(step7Fields)], null, 2) + '</pre>';
                    output += '<h4>Step 8 Fields:</h4><pre>' + JSON.stringify([...new Set(step8Fields)], null, 2) + '</pre>';
                    output += '<h4>Step 9 Fields:</h4><pre>' + JSON.stringify([...new Set(step9Fields)], null, 2) + '</pre>';
                    
                    result.innerHTML = output;
                })
                .catch(error => {
                    result.innerHTML = '<p class="fail">Error: ' + error.message + '</p>';
                });
        }
        
        function loadDraft() {
            const draftId = document.getElementById('draftIdInput').value;
            const result = document.getElementById('draftResult');
            result.innerHTML = '<p class="info">Loading draft...</p>';
            
            fetch('load-draft.php?draft_id=' + draftId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let output = '<p class="pass">✓ Draft loaded successfully</p>';
                        output += '<h4>Current Step: ' + data.draft_data.current_step + '</h4>';
                        
                        // Check for Step 7, 8, 9 fields
                        const formData = data.draft_data.form_data;
                        const step7Fields = ['fault_code_present'];
                        const step8Fields = ['central_lock_working', 'ignition_switch', 'driver_front_indicator_elec', 
                                            'passenger_front_indicator_elec', 'driver_headlight_working', 
                                            'passenger_headlight_working', 'check_all_buttons'];
                        const step9Fields = ['ac_turning_on', 'ac_cool_temperature', 'ac_hot_temperature', 
                                            'ac_direction_mode', 'defogger_front_vent', 'defogger_rear_vent',
                                            'ac_all_vents', 'ac_abnormal_vibration'];
                        
                        output += '<h4>Step 7 Fields in Draft:</h4><ul>';
                        step7Fields.forEach(field => {
                            const value = formData[field];
                            if (value !== undefined && value !== '') {
                                output += `<li class="pass">✓ ${field}: ${JSON.stringify(value)}</li>`;
                            } else {
                                output += `<li class="fail">✗ ${field}: Not saved</li>`;
                            }
                        });
                        output += '</ul>';
                        
                        output += '<h4>Step 8 Fields in Draft (sample):</h4><ul>';
                        step8Fields.forEach(field => {
                            const value = formData[field];
                            if (value !== undefined && value !== '') {
                                output += `<li class="pass">✓ ${field}: ${JSON.stringify(value)}</li>`;
                            } else {
                                output += `<li class="fail">✗ ${field}: Not saved</li>`;
                            }
                        });
                        output += '</ul>';
                        
                        output += '<h4>Step 9 Fields in Draft:</h4><ul>';
                        step9Fields.forEach(field => {
                            const value = formData[field];
                            if (value !== undefined && value !== '') {
                                output += `<li class="pass">✓ ${field}: ${JSON.stringify(value)}</li>`;
                            } else {
                                output += `<li class="fail">✗ ${field}: Not saved</li>`;
                            }
                        });
                        output += '</ul>';
                        
                        output += '<h4>Uploaded Files:</h4><pre>' + JSON.stringify(data.draft_data.uploaded_files, null, 2) + '</pre>';
                        
                        result.innerHTML = output;
                    } else {
                        result.innerHTML = '<p class="fail">Error: ' + data.message + '</p>';
                    }
                })
                .catch(error => {
                    result.innerHTML = '<p class="fail">Error: ' + error.message + '</p>';
                });
        }
        
        function checkFormFields() {
            const result = document.getElementById('formFieldsResult');
            result.innerHTML = '<p class="info">This test requires the form to be loaded in the parent page.</p>';
            result.innerHTML += '<p>Please run this test from the main form page console instead.</p>';
        }
    </script>
</body>
</html>
